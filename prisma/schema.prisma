
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                        String        @id @default(cuid())
  email                     String        @unique
  name                      String?
  passwordHash              String
  isAdmin                   Boolean       @default(false)
  isSuperAdmin              Boolean       @default(false)
  blocked                   Boolean       @default(false)
  emailVerified             Boolean       @default(false)
  emailVerificationToken    String?
  emailVerificationTokenExpiry DateTime?
  passwordResetToken        String?
  passwordResetTokenExpiry  DateTime?
  draws                     DrawSession[]
  smtpConfig                SmtpConfig?
  sharedSessions            DrawSessionShare[] @relation("SharedBy")
  acceptedShares            DrawSessionShare[] @relation("AcceptedBy")
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
}

model DrawSession {
  id           String         @id @default(cuid())
  ownerId      String
  owner        User           @relation(fields: [ownerId], references: [id])
  name         String
  description  String?
  emailSubjectTemplate String?
  emailTemplate String?
  participants Participant[]
  assignments  Assignment[]
  groups       Group[]
  shares       DrawSessionShare[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([ownerId, name])
}

model Participant {
  id            String           @id @default(cuid())
  drawSessionId String
  drawSession   DrawSession      @relation(fields: [drawSessionId], references: [id], onDelete: Cascade)
  name          String
  email         String
  groups        ParticipantGroup[]
  assignmentsGiven     Assignment[] @relation("AssignmentsGiven")
  assignmentsReceived  Assignment[] @relation("AssignmentsReceived")

  @@unique([drawSessionId, name])
}

model Group {
  id            String            @id @default(cuid())
  drawSessionId String
  drawSession   DrawSession       @relation(fields: [drawSessionId], references: [id], onDelete: Cascade)
  name          String
  participants  ParticipantGroup[]

  @@unique([drawSessionId, name])
}

model ParticipantGroup {
  participantId String
  groupId       String

  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  group         Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([participantId, groupId])
}

model Assignment {
  id            String       @id @default(cuid())
  drawSessionId String
  drawSession   DrawSession  @relation(fields: [drawSessionId], references: [id], onDelete: Cascade)
  giverId       String
  receiverId    String
  giver         Participant  @relation("AssignmentsGiven", fields: [giverId], references: [id], onDelete: Cascade)
  receiver      Participant  @relation("AssignmentsReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  emailSentAt   DateTime?
  emailSendCount Int         @default(0)
}

model SmtpConfig {
  id       String  @id @default(cuid())
  userId   String  @unique
  user     User    @relation(fields: [userId], references: [id])
  host     String
  port     Int
  secure   Boolean
  userName String?
  password String?
  sender   String
}

model DrawSessionShare {
  id            String      @id @default(cuid())
  drawSessionId String
  drawSession   DrawSession @relation(fields: [drawSessionId], references: [id], onDelete: Cascade)
  email         String
  token         String?     @unique
  tokenExpiry   DateTime?
  sharedById    String
  sharedBy      User        @relation("SharedBy", fields: [sharedById], references: [id])
  sharedAt      DateTime    @default(now())
  acceptedAt    DateTime?
  acceptedById  String?
  acceptedBy    User?       @relation("AcceptedBy", fields: [acceptedById], references: [id])

  @@index([drawSessionId])
  @@index([email])
}
